
    %\subsection{Návrh PCB}
    %Tady bude sekce o návrhu PCB. Zatím není navrženo.
    %Ve výrobě jsou měřící karty, které by snad i s osazením měly být hotové do obhajoby semestrální práce.
    %Poté bude měřící karta otestována jejich funkčnost pomocí NUCLEO prototypových kitů.
    %Po verifikaci funkčnosti bude vyrobena ovládací karta.
    %Bude se pravděpodobně jednat o šestivrstvé PCB s řízenými impedancemi pro diferenciální páry.
    %    \subsubsection{USB routing}
    %Nějaký stručný popis vlivu impedance cesty na rychlost USB...
    %\subsubsection{Ethernet routing}
    %Nějaký stručný popis vlivu impedance cesty na rychlost Ethernetu. Signal integrity atd..
    %\subsubsection{STM32F4 routing}
    %Vliv decoupling kondenzátorů.
    %\subsubsection{Fyzické rozměry}
    %Na rozdíl od měřících karet, kde byl kladen důraz na maximální výšku karty z důvodu roztečí bRC pinů, nejsou
    %kladeny na ovládací karty žádné omezení, protože ovládací karty budou propojeny s měřícími kartami
    %pomocí páskových vodičů. Rozměry by však měly být co nejkompaktnější. Propojit měřící karty s bRC piny pomocí
    %páskových vodičů nebylo žádoucí z důvodu vnášení chyby měření do systému.
    %\clearpage


\chapter{Algoritmizace a měřící procedury}
Jak již bylo zmíněno v kapitole o systémové koncepci a na obr.\ref{fig:Systémová koncepce}.
Jednotlivé ovládací karty jsou propojeny pomocí ethernetového rozhraní do switche.
Pro správnou funkčnost testeru je zde použit spravovatelný switch, který mimo jiné umožňuje
získat informace o své MAC tabulce. MAC tabulku společně s protokolem ARP lze využít pro
přiřazení čísla portu ethernetového switche k IP adrese připojených ovládacích karet. Tímto způsobem
lze přiřadit jednotlivé ovládací karty k jednotlivým řadám bRC pinů bez nutnosti dodatečné konfigurace
či různému kódování řad.\par

Z pohledu celého systému je hlavním řídícím prvkem PC aplikace. V následující části je popsán Komunikační
protokol, který je použit pro komunikaci mezi PC aplikací a ovládacími kartami.

\section{Komunikační protokol ovládacích karet}
Komunikační protokol je založen na ASCII příkazech a je tak relativně čitelný pro člověka.
Jednotlivé příkazy protokolu jsou přenášeny pomocí TCP/IP rámců (port 23) v případě ethernetového rozhraní nebo
pomocí Virtuálního COM portu v případě USB rozhraní. Pro obě možnosti připojení se protokol neliší.\par

Jednotlivé příkazy jsou vyhodnocovány po obdržení znaku CR (ASCII 0x0D), LF (ACII 0x0A) nebo jejich libovolnou kombinací. Odpovědi
z ovládacích karet jsou zakončeny znakem LF. Ovládací karta je určena obecně k ovládání více modulů než pouze měřících karet. Nicméně pro účely
diplomové práce jsou diskutovány pouze příkazy vztahující se k měřícím kartám. Každý příkaz vztahující se k měřícím kartám obsahuje prefix 80\_IO\_CARD.
Jednotlivé parametry příkazu jsou odděleny mezerou.\par

Pro každý příkaz odesílá ovládací karta odpovědi začínajícími
prefixem "ERROR;"\ nebo "OK;"\ (bez uvozovek) podle toho, zdali byl příkaz vyhodnocen úspěšně či nikoliv.
Poté následuje textová odpověď na příkaz zakončená znakem LF.
Příkazy jsou rozděleny do 3 skupin (SET READ a MEASUERE).
Skupina SET slouží k nastavení parametrů měření, skupina READ slouží k čtení nastavených parametrů
a skupina MEASURE slouží k samotnému měření.\par

V následujících podkapitolách jsou popsány jednotlivé příkazy pomocí následující konvence:
\begin{itemize}
    \item Znak | značí, že je možné použít pouze jeden z uvedených parametrů.
    \item Text v uvozovkách značí nastavitelnou hodnotu do příkazu se zadává bez uvozovek a v případě desetinných čísel je použita desetinná tečka.
    \item Text mezi * je vysvětlen podrobněji v dané sekci
    
\end{itemize}

\subsection{Příkazy SET}
\subsubsection{SET DAC}
Příkaz SET DAC slouží k nastavení napětí na výstupu DAC. Protože se jedná o 12bitový převodník, je možné nastavit pouze hodnoty napětí, které jsou násobky
napětí referenčního napětí. Pokud je zadáno napětí, které není násobkem referenčního napětí, je nastaveno nejbližší nižší napětí.
Referenční napětí ovládací karty je nastaveno při kalibraci příkazem SET CONFIGURATION VOLTAGE\_REFERENCE.
Případně je hodnotu referenčního napětí možno získat
příkazem READ CONFIGURATION VOLTAGE\_READINGS.
\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD SET DAC "Napětí ve V"
    \item \textbf{Příklad:}\\
    -> 80\_IO\_CARD SET DAC 2.75\\
    <- OK;DAC: 3398, discretized Value in Volts:2.74959
    \item \textbf{Interpretace odpovědi:} Tato odpověď byla obdržena při referenčním napětí 3.314400V.
    Hodnota 3398 je bitová hodnota, která je zapsána do registru DAC a
    hodnota 2.74959 je odpovídající hodnota napětí.
\end{itemize}

\subsubsection{SET SHIFT\_REGISTER}
Příkaz SET SHIFT\_REGISTER slouží k nastavení výstupní hodnoty posuvného registru či celé skupiny posuvných registrů.
Prvním parametrem příkazu je volba skupiny posuvných registrů.
Relevantní skupiny posuvných registrů pro diplomovou práci jsou IO1TO40\_OUTPUTS, IO41TO80\_OUTPUTS, IO1TO40\_IMPEDANCES a IO41TO80\_IMPEDANCES.
Správnou kombinací výstupů těchto posuvných registrů lze nastavit jakýkoliv bRC pin do vysoké či nízké impedance a případně i výstupní hodnotu napětí.\par

Druhým parametrem je volba způsobu zadání výstupní hodnoty registrů. K dispozici jsou následující možnosti: VALUE a DO\_N\_SHIFTS.
V případě možnosti VALUE následuje decimální hodnota jejíž bitové vyjádření reprezentuje stavy jednotlivých výstupů posuvných registrů.
Každý ze skupin registrů má svoji endianitu, kterou lze zjistit z příkazu READ CONFIGURATION SHIFT\_REGISTERS (podrobněji popsáno dále). 
Druhou možností je využití parametru DO\_N\_SHIFTS,
který posune celý obsah posuvného registru o zadaný počet bitů vpravo či vlevo v závislosti na endianitě registru.

\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD SET SHIFT\_REGISTER *registr* *způsob* "Hodnota"
    \item \textbf{*registr*:} IO1TO40\_OUTPUTS, IO41TO80\_OUTPUTS,\\
    IO1TO40\_IMPEDANCES, IO41TO80\_IMPEDANCES
    \item \textbf{*způsob*:} VALUE, DO\_N\_SHIFTS
    \item \textbf{Příklad:}\\
    -> 80\_IO\_CARD SET SHIFT\_REGISTER IO1TO40\_IMPEDANCES VALUE 4\\
    <- OK;Setting Register:IO1TO40\_IMPEDANCES to:4\\
    -> 80\_IO\_CARD SET SHIFT\_REGISTER IO1TO40\_IMPEDANCES DO\_N\_SHIFTS 4\\
    <- OK;Setting Register:IO1TO4\_IMPEDANCES to:16
    \item \textbf{Interpretace odpovědi:} Obecně lze vždy v odpovědi nalézt nový stav registru po provedení požadované operace.
\end{itemize}

\subsubsection{SET CONFIGURATION}
Příkazy v této skupině obecně slouží k nastavení stavových hodnot, kalibračních hodnot případně nastavení způsobu
měření určitých hodnot. Hodnoty, které potřebují být nastaveny pomocí prefixu SET CONFIGURATION, jsou popsány v sekcích,
pro které jsou tyto hodnoty používány.
Ukázky vybraných hodnot, které lze nastavit pomocí příkazu SET CONFIGURATION jsou uvedeny například v sekci READ CONFIGURATION.

\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD SET CONFIGURATION *Název konfigurace* "Hodnota"
    \item \textbf{*Název konfigurace*:} Popsáno v sekcích, pro které jsou hodnoty používány.
    \item \textbf{Příklad:}\\
    -> 80\_IO\_CARD SET CONFIGURATION VOLTAGE\_REFERENCE 3.3144\\
    <- OK;VOLTAGE\_REFERENCE set to:3.314400
    \item \textbf{Interpretace odpovědi:} Obecně lze vždy v odpovědi nalézt potvrzení o nastavení hodnoty.
\end{itemize}

\subsection{Příkazy READ}
\subsubsection{READ MUX}
Příkaz READ MUX umožňuje číst hodnoty z multiplexerů umístěných na ovládací kartě. Příkaz se skládá ze 2 parametrů. Prvním parametrem je volba
skupiny multiplexerů. Pro ovládací kartu jsou k dispozici 2 skupiny (MUXES\_1TO40 a MUXES\_41TO80). Druhým parametrem je volba podoby obdržené hodnoty.
První možností je přečíst hodnotu celé skupiny multiplexerů za použití parametru ALL. Výsledkem tohoto příkazu je 40bitové číslo v decimální podobě,
kde každý bit reprezentuje stav jednoho bRC pinu připojeného ke zvolenému multiplexeru.
40bitová hodnota je vztažena k endianitě multiplexeru, kterou lze zjistit
příkazem 80\_IO\_CARD READ CONFIGURATION MULTIPLEXERS.
Druhou možností je zadat přímo číslo pinu, jehož stav chceme zjistit. Výsledkem tohoto příkazu je 1bitová hodnota v decimální podobě.
\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD READ MUX *multiplexer* "číslo pinu"|ALL
    \item \textbf{*multiplexer*:} MUXES\_1TO40 a MUXES\_41TO80
    \item \textbf{Příklad:}\\
    -> 80\_IO\_CARD READ MUX MUXES\_1TO40 ALL\\
    <- OK;Reading MUX MUXES\_1TO40, ALL:0\\
    -> 80\_IO\_CARD READ MUX MUXES\_1TO40 1\\
    <- OK;Reading MUX: MUXES\_1TO40, address:1, value:0
    \item \textbf{Interpretace odpovědi:} V případě parametru ALL je v odpovědi obsažena 40bitová hodnota v decimální podobě.
    V případě zadání čísla pinu je v odpovědi obsažena 1bitová hodnota v decimální podobě.
\end{itemize}

\subsubsection{READ SHIFT\_REGISTER}
Tento příkaz slouží k získání aktuální hodnoty shiftregistru. Jediným parametrem tohoto příkazu je jméno skupiny shiftregistru.

\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD READ MUX *register*
    \item \textbf{*register*:} IO1TO40\_OUTPUTS, IO41TO80\_OUTPUTS,\\
    IO1TO40\_IMPEDANCES, IO41TO80\_IMPEDANCES
    \item \textbf{Příklad:}\\
    -> 80\_IO\_CARD READ SHIFT\_REGISTER IO1TO40\_OUTPUTS\\
    <- OK;Reading Register IO1TO40\_OUTPUTS, value:1099511627775\\
    \item \textbf{Interpretace odpovědi:} V odpovědi je obsažena 40bitová hodnota v decimální podobě,
    kde jednotlivé bity této hodnoty značí aktuální výstupní hodnotu shiftregistru v závislosti na jeho endianitě.
    V případě výpadku napájení se může stát, že hodnota shiftregistru nebude odpovídat skutečnému stavu výstupních pinů.
\end{itemize}


\subsubsection{READ CONFIGURATION}
Příkaz READ CONFIGURATION slouží k získání konfigurace ovládací karty. Ovládací karta obsahuje poměrně obsáhlé množství konfigurací.
V této sekci jsou popsány pouze ty konfigurace, které jsou využívány v diplomové práci. Některé vyčtené tímto příkazem nastavovat
pomocí příkazu SET CONFIGURATION.
\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD READ CONFIGURATION *konfigurace*
    \item \textbf{Příklad SHIFT\_REGISTERS:}\\
    -> 80\_IO\_CARD READ CONFIGURATION SHIFT\_REGISTERS\\
    <- OK;IO1TO40\_OUTPUTS:(length:40,endianity:1,value:1099511627775);\\
    IO41TO80\_OUTPUTS:(length:40,endianity:0,value:0);\\
    IO1TO40\_IMPEDANCES:(length:40,endianity:1,value:1);\\
    IO41TO80\_IMPEDANCES:(length:40,endianity:0,value:0);
    \item \textbf{Interpretace odpovědi:} V odpovědi jsou obsaženy veškeré informace o konfiguraci posuvných registrů.
    \item \textbf{Příklad MULTIPLEXERS:}\\
    -> 80\_IO\_CARD READ CONFIGURATION MULTIPLEXERS\\
    <- OK;MUXES\_1TO40:(bits:8,paralel:5,endianity:0,value:0);\\
    MUXES\_41TO80:(bits:8,paralel:5,endianity:0,value:0);
    \item \textbf{Interpretace odpovědi:} V odpovědi jsou obsaženy veškeré informace o konfiguraci multiplexerů.
    \item \textbf{Příklad VOLTAGE\_READINGS:}\\
    -> 80\_IO\_CARD READ CONFIGURATION VOLTAGE\_READINGS\\
    <- OK;DAC\_RAMP\_DIRECTION:0;\\
    DAC\_RAMP\_MIN\_VALUE\_VALUE:0;\\
    DAC\_RAMP\_MAX\_VALUE\_VALUE:4095;\\
    DAC\_RAMP\_STEP:1;\\
    DAC\_RAMP\_DELAY\_2500\_NS:2;\\
    VOLTAGE\_READ\_AVERAGES:2;\\
    VOLTAGE\_REFERENCE:3.314400;
    \item \textbf{Interpretace odpovědi:} V odpovědi jsou obsaženy veškeré nastavitelné parametry, které se využívají při měření napětí na jednotlivých pinech příkazy MEASURE.
\end{itemize}





\subsection{Příkazy MEASURE} \label{measure commands}
\subsubsection{MEASURE VOLTAGE}
Příkaz MEASURE VOLTAGE slouží k měření napětí na určitém bRC pinu či pinech.
V případě použití parametru ALL je změřeno napětí na všech 80 pinech měřící karty.
V případě, že je místo parametru ALL zadáno číslo tak příkaz vrátí hodnotu napětí na daném pinu.\\

\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD MEASURE VOLTAGE ALL|"číslo pinu"
    \item \textbf{Příklad ALL:}\\
    -> 80\_IO\_CARD MEASURE VOLTAGE ALL\\
    <- OK;2.965643;2.860450;2.431585;-1.000000;0.922465;........;-1.00000;-1.000000;
    \item \textbf{Interpretace odpovědi:} V odpovědi jsou obsaženy
    hodnoty napětí na všech 80 pinech odděleny znakem středníku (;). "...." v příkladu značí, že výpis byl zkrácen.
    Hodnota -1 značí, že napětí je mimo rozsah měřící karty.

    \item \textbf{Příklad číslo pinu:}\\
    -> 80\_IO\_CARD MEASURE VOLTAGE 3
    <- OK;Voltage:2.128143\\
    \item \textbf{Interpretace odpovědi:} V odpovědi je obsaženo napětí na pinu 3 (číslováno od 0). V případě, že napětí je mimo rozsah měřící karty, tak příkaz vrátí hodnotu -1.
\end{itemize}

Proces měření napětí lze konfigurovat pomocí příkazů ze skupiny SET CONFIGURATION. Následující část popisuje vliv vybraných parametrů.
Měření napětí probíhá pomocí porovnávání nastavené hodnoty D/A převodníku s měřenou hodnotou napětí na bRC pinu. V reálném zapojení je tohoto dosaženo pomocí komparátoru.
Výstup komparátoru je z důvodu velkého množství pinů multiplexován na digitální vstup mikrokontroléru (Obr.\ref{fig: bRC pin voltage measurement}). 
\begin{figure}[ht!]
    \centering
    \includegraphics[width = 0.8\textwidth]{obrazky/Voltage_measurement_example.png}
    \caption{Zjednodušené schéma zapojení pro měření napětí na bRC pinu}
    \label{fig: bRC pin voltage measurement}
\end{figure}
Měření popsána v této sekci byla provedena na reálné měřící kartě, kde výstup multiplexeru pro měřený bRC pin je přiveden na pin D1 ovládací karty. Měření byla provedena pomocí
osciloskopu KEYSIGHT DSOX1204A a digitálního 6.5místného multimetru GWINSTEK GDM-9061.
Kde jednotlivé průběhy napětí jsou následně zpracovány pomocí programu MATLAB.\par

Na obrázku \ref{fig: bRC pin voltage measurement DACRAMP1} je zobrazen průběh napětí jednotlivých uzlů z obr. \ref{fig: bRC pin voltage measurement}. Modře je znázorněna měřená hodnota napětí na bRC pinu,
která má podle multimetru hodnotu 2.1475V, přičemž příkaz vrátil hodnotu napětí 2.1275V.
Tato hodnota je závislá na nastavení napěťové reference příkazem 80\_PIN\_CARD SET CONFIGURATION VOLTAGE\_REFERENCE.\par

Červeně je zobrazena hodnota napětí na výstupu D/A převodníku a zeleně je znázorněn výstup multiplexeru. 
Každá z následujících diskutovaných konfigurací v této sekci začíná prefixem 80\_PIN\_CARD SET CONFIGURATION, přičemž je tento prefix vynecháván.\par
\begin{figure}[ht!]
    \centering
    \includegraphics[width =1\textwidth]{obrazky/matlab_generated/pin_step1.eps}
    \caption{Časové průběhy napětí - měření napětí na bRC pinu (DAC\_RAMP = 1)}
    \label{fig: bRC pin voltage measurement DACRAMP1}
\end{figure}
Měření napětí probíhá tak,
že se na D/A převodníku nastavují sestupně (případně vzestupně v závislosti na konfiguraci DAC\_RAMP\_DIRECTION) hodnoty napětí.
Při každém kroku se kontroluje,
zda nedošlo k překlopení napěťové úrovně na výstupu komparátoru (respektive multiplexeru - D1 pin).\par

Detekce překlopení probíhá tak, že se vyčítá N-krát
(lze nastavit konfigurací \linebreak VOLTAGE\_READ\_AVERAGES) logická hodnota na pinu D1.
Pokud je alespoň polovina z takto vyčtených hodnot opačné logické úrovně než logická úroveň pinu D1 na počátku měření,
tak se přepočte aktuálně nastavená hodnota registru D/A převodníku na napětí a toto napětí se odešle do PC aplikace.
Detekce překlopení komparátoru je patrná na obrázku \ref{fig: bRC pin voltage measurement DACRAMP1}
přibližně v čase 30\,ms.\par

Další nastavitelnou konfigurací je DAC\_RAMP\_STEP, která udává bitový krok rampy D/A převodníku. Takto lze měření urychlit za cenu snížení přesnosti.
Na obrázku \ref{fig: bRC pin voltage measurement DACRAMP5} je zobrazen průběh napětí při nastavení DAC\_RAMP\_STEP = 5. Touto změnou
bylo dosaženo změření stejného napětí jako v předchozím bodě přibližně za 6\,ms.\par
\clearpage
\begin{figure}[ht!]
    \centering
    \includegraphics[width = 1\textwidth]{obrazky/matlab_generated/pin_step5.eps}
    \caption{Časové průběhy napětí - měření napětí na bRC pinu (DAC\_RAMP = 5)}
    \label{fig: bRC pin voltage measurement DACRAMP5}
\end{figure}

Z obrázků \ref{fig: bRC pin voltage measurement DACRAMP1} a \ref{fig: bRC pin voltage measurement DACRAMP5} lze dedukovat, že celkový čas je závislý 
na měřeném napětí. V případě, že je zvolena sestupná rampa a měřené napětí je nulové budou průběhy vypadat následovně:
\begin{figure}[ht!]
    \centering
    \includegraphics[width = 1\textwidth]{obrazky/matlab_generated/pin_out_of_range.eps}
    \caption{Časové průběhy napětí - měření nízkého napětí na bRC pinu (DAC\_RAMP = 5)}
    \label{fig: bRC pin voltage measurement low Voltage}
\end{figure}

Na obrázku \ref{fig: bRC pin voltage measurement low Voltage} lze pozorovat, že pokud napětí je příliš nízké, tak se výstup komparátoru nikdy nepřeklopí a 
příkaz vrátí v odpovědi hodnotu -1.
To je způsobeno tím, že D/A převodník není schopen generovat nulové napětí.
Při nastavení registru D/A převodníku na 0 je na výstupu převodníku napětí přibližně 70\,mV.
Lze tak měřit pouze napětí, které je vyšší než tato dolní mez. Horní mez měření není omezena, protože napájecí napětí bRC pinů je nižší než napětí,
které je D/A převodník schopen generovat. Zároveň obrázek \ref{fig: bRC pin voltage measurement low Voltage} demonstruje přibližnou maximální dobu
měření (19ms pro DAC\_RAMP\_STEP = 5 a 95ms pro \mbox{(DAC\_RAMP\_STEP = 1)}.
\clearpage
Vzhledem k charakteru propojení bRC pinů, kde je většina pinů buď propojena tvrdým zkratem
(napětí na bRC pinu blízké 3V) nebo rozpojená (napětí na pinu blízké 0V),
vzniká potřeba zkrátit čas měření napětí mimo rozsah D/A převodníku.
Z tohoto důvodu je před začátkem měření nejprve změřena logická hodnota výstupu multiplexeru (D1 pin) při
nejnižší a nejvyšší napěťové hodnotě D/A převodníku.
Pokud je výstup multiplexeru v obou případech stejný, tak se předpokládá, že je hodnota nižší než dolní mez D/A převodníku
a příkaz vrátí hodnotu -1. Při reálném provozu, tak nemůže nastat situace z obr. \ref{fig: bRC pin voltage measurement low Voltage}.
Měření pak probíhá podle obr. \ref{fig: bRC pin voltage measurement low Voltage opt}.
Optimalizované měření pak v případě, že je měřená hodnota mimo rozsah,
trvá pouze přibližně 0.02\,ms nezávisle na použitých konfigurací.\par

\begin{figure}[ht!]
    \centering
    \includegraphics[width = 1\textwidth]{obrazky/matlab_generated/pin_out_of_range_opt.eps}
    \caption{Časové průběhy napětí - měření nízkého napětí na bRC pinu optimalizace}
    \label{fig: bRC pin voltage measurement low Voltage opt}
\end{figure}


Další konfigurace, které lze využít jsou DAC\_RAMP\_MAX\_VALUE\linebreak a DAC\_RAMP\_MIN\_VALUE,
které určují dolní a horní mez rampy D/A převodníku. Tímto lze zkrátit čas měření za cenu nižšího rozsahu.
Zároveň je na tyto mezní hodnoty aplikována stejná metoda jako je popsána v předchozím odstavci.
Nicméně nyní dolní mez D/A převodníku nepředstavuje hardwarovou dolní mez měření,
nýbrž mez nastavenou příkazem DAC\_RAMP\_MIN\_VALUE.
V případě využívání DAC\_RAMP\_MAX\_VALUE může dojít k měření hodnoty napětí mimo tuto horní mez. Protože pro funkčnost měřící karty není
nutné rozlišovat, zda měřená hodnota je nad horní nebo pod dolní mezí, tak v obou případech vrací příkaz hodnotu -1.\par 

Prozatím bylo diskutováno pouze měření napětí na jednom pinu.
V případě \linebreak příkazu 80\_IO\_CARD MEASURE VOLTAGE ALL jsou změřena napětí na všech bRC pinech současně během jedné rampy
D/A převodníku (Obr. \ref{fig: bRC pin voltage measurement allpins} na další straně).

\clearpage
\begin{figure}[ht!]
    \centering
    \includegraphics[width = 1\textwidth]{obrazky/matlab_generated/all_pins.eps}
    \caption{Časové průběhy napětí - měření napětí na všech pinech současně}
    \label{fig: bRC pin voltage measurement allpins}
\end{figure}

Měření všech pinů probíhá obdobně jako u měření jednotlivých pinů. Nejprve se u všech pinů zkontroluje, zda je měřené napětí v mezích.
Následuje D/A rampa, kde se při každém kroku kontroluje u každého pinu, zda nedošlo k překlopení komparátoru. Pokud dojde k překlopení komparátoru,
tak se uloží aktuální hodnota D/A převodníku do paměti mikrokontroléru. Pokud je pro daný pin již v paměti uložená nějaká hodnota, tak při dalším
kroku D/A rampy již nedochází ke kontrole překlopení komparátoru. To je patrné z obr. \ref{fig: bRC pin voltage measurement allpins}, kde není rampa
D/A převodníku lineární a postupně se měření urychluje s počtem již změřených pinů.\par 

Zelený průběh napětí na D1 pinu vypadá takto, protože se jedná o výstup multiplexeru. Multiplexery jsou řízeny pomocí společné adresace, takže
se v průběhu měření, opakovaně a nechtěně, přepíná i výstup již změřeného pinu. Teoreticky by se dalo předpokládat, že takováto aktivita na všech
výstupních pinech multiplexerů bude způsobovat rušení, nicméně při dosavadním měření se tato skutečnost nijak výrazně neprojevila, a tak je ignorována.
Případně by rušení šlo do jisté míry omezit správnou posloupností měření pinů.

\subsubsection{MEASURE ADC}
Tento příkaz slouží k změření aktuální hodnoty A/D převodníku. Příkaz vrací hodnotu již přepočtenou na napětí, 
toto napětí je vztaženo k referenčnímu napětí,
které lze nastavit příkazem 80\_IO\_CARD SET CONFIGURATION VOLTAGE\_REFERENCE

\begin{itemize}[leftmargin=*]
    \item \textbf{Obecný tvar:} 80\_IO\_CARD MEASURE ADC
    \item \textbf{Příklad:}\\
    -> 80\_IO\_CARD MEASURE ADC\\
    <- OK;ADC, value:3.004\\
    \item \textbf{Interpretace odpovědi:} Odpověď obsahuje změřenou hodnotu A/D převodníku vztaženou k referenčnímu napětí.
\end{itemize}

\section{Režimy měření}
V části o návrhu měřící karty byly stručně zmíněny 2 módy měření (PASS/FAIL a měření přesné hodnoty).

\subsection{Mód PASS/FAIL}
V sekci (Volba velikosti odporu děliče Rout) byly zmíněny dva módy, ve kterých tester funguje.
Prvním z módu je PASS/FAIL mód. V tomto módu používá obsluha externí sondu připojenou k pinu č. 80
měřící karty připojené k ovládací kartě č.1. Obsluha je vyzvána k připojení externí sondy k 
určité testovací jehle (probe). Tester následně otestuje, které propojení mezi bRC piny a sondou splňuje požadavky
na mezní hodnotu odporu cesty. Výsledkem tohoto testu tak není přesná hodnota odporu měřené cesty,
ale pouze logická hodnota v závislosti, zda je odpor měřené cesty nižší než určitá zvolená mez.\par

Naměřená data jsou odesílána do PC aplikace, která výsledky porovnává
s konfiguračními soubory a v závislosti na výsledku informuje obsluhu o dalším postupu.
Informování obsluhy je realizováno akusticky (obdobně jako continuity test u multimetru)
a vizuálně na displeji. Celý systém tak musí provést měření, co nejrychleji, aby aplikace byla schopna informovat
obsluhu v reálném čase s co nejnižší odezvou.\par

Reálně je měření prováděno tak, že se nejprve nastaví D/A převodník na hodnotu 2.9V.
Dále se nastaví všechny piny do vysoké impedance. Následně je na pinu č.80 (externí sonda) nastavena vysoká logická úroveň (3V).
Dalším krokem je vyčtení logických hodnot pinů na všech připojených kartách. V případě, že je pin propojen s externí sondou,
tak nezávislé na jeho odporu (do stovek k\,$\Omega$) bude hodnota napětí na pinu vyšší než hodnota D/A převodníku a pin
bude logické úrovně 1. V případě, že pin není propojen s externí sondou, tak bude mít hodnotu napětí na pinu nižší než je hodnota
D/A převodníku, a pin bude logické úrovně 0. Zvolená hodnota D/A převodníku na 2.9V je záměrně zvolena takto vysoká, protože
napětí na pinu ve vysoké úrovni bez přivedení externího signálu není definováno, nicméně při dlouhodobém měření nikdy nepřesáhlo
hodnotu vyšší než 2V (kapitola \ref{tehcnical parameters}).\par

Tímto lze dosáhnout proměření všech bRC pinů s externí sondou, avšak bez zvolení mezní hodnoty odporu cesty. Důvodem,
proč se nejprve nastavují všechny piny do vysoké impedance je ten, že by při vysokém počtu propojených pinů mohl protékat
pinem externí sondy vysoký proud a mohlo by tak dojít k poškození zařízení. Ze získané informace o propojení pinů s externí sondou
se následně postupně nastavují skupiny pinů do nízké impedance (obvykle lze změřit všechny piny zároveň). Dále se nastaví D/A převodník
tak, aby hodnota výstupu odpovídala mezní hodnotě požadovaného odporu cesty a vyčtou se logické hodnoty všech pinů.
Nyní je však výsledkem této operace zmapování všech propojení s externí sondou, které splňují požadavky na mezní hodnotu odporu cesty.\par

Protože se při testu vyčítají pouze logické hodnoty pinů (s výjimkou 2 hodnot nastavení D/A převodníku),
tak je možné tento test provádět mnohem rychleji než měření přesné hodnoty odporu.
Protože je tento test závislý na rychlosti PC aplikace a propustnosti ethernetové sítě,
nelze snadno specifikovat jeho celkový čas. Obvykle se však stihne vše provést do 30\,ms.

\subsection{Mód měření přesné hodnoty odporu}
Tento mód se oproti PASS/FAIL módu liší tím, že zde nejsou kladeny vysoké nároky na čas měření, protože proces
je plně automatizován a měření probíhá pouze mezi bRC piny. Výsledkem tohoto měření je pak přesná hodnota odporu propojených pinů.
Tento mód lze využít i pro měření pomocí externí sondy. V tomto případě se aplikuje obdobný postup jako v případě PASS/FAIL módu
s výjimkou posledního kroku, kde se místo logických úrovní pinů vyčte přesná hodnota napětí pomocí příkazu
80\_IO\_CARD MEASURE VOLTAGE ALL na všech ovládacích kartách. Hodnota napětí je pak v PC aplikaci přepočítána na hodnotu odporu.
Doba trvání takového měření je časově proměnná z důvodu diskutovaných 
v sekci \ref{measure commands}.
